name: PR Reviewer

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Prevent concurrent reviews on the same PR
concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  review:
    # Run on PR events, issue comments on PRs, or review comments (not from bots)
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && !contains(github.event.comment.user.login, '[bot]')) ||
      (github.event_name == 'pull_request_review_comment' && !contains(github.event.comment.user.login, '[bot]'))
    runs-on: ubuntu-latest

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PR_REVIEWER_APP_ID }}
          private-key: ${{ secrets.PR_REVIEWER_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR head
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_SHA_DIRECT: ${{ github.event.pull_request.head.sha }}
        run: |
          if [ -n "$PR_SHA_DIRECT" ]; then
            git checkout $PR_SHA_DIRECT
          else
            PR_NUMBER=${{ github.event.issue.number }}
            PR_SHA=$(gh pr view $PR_NUMBER --json headRefOid -q '.headRefOid')
            git checkout $PR_SHA
          fi

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR context
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_ACTION=${{ github.event.action }}" >> $GITHUB_ENV
          
          # Always get the full diff for inline comment validation
          gh pr diff $PR_NUMBER > pr-diff.txt
          
          # Fetch previous bot reviews for conversation context
          gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.user.login | contains("[bot]")) | select(.body | contains("pr-reviewer-bot")) | {id: .id, body: .body, submitted_at: .submitted_at}]' > previous-reviews.json 2>/dev/null || echo '[]' > previous-reviews.json
          
          REVIEW_COUNT=$(jq 'length' previous-reviews.json)
          echo "REVIEW_COUNT=$REVIEW_COUNT" >> $GITHUB_ENV
          
          if [ "${{ github.event.action }}" = "synchronize" ] && [ "$REVIEW_COUNT" -gt 0 ]; then
            echo "IS_FOLLOWUP=true" >> $GITHUB_ENV
            
            # Get the last review timestamp to find new commits
            LAST_REVIEW_TIME=$(jq -r 'last | .submitted_at' previous-reviews.json)
            echo "Last review was at: $LAST_REVIEW_TIME"
            
            # Get commits since last review
            gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/commits" \
              --jq "[.[] | select(.commit.committer.date > \"$LAST_REVIEW_TIME\") | {sha: .sha, message: .commit.message}]" > new-commits.json 2>/dev/null || echo '[]' > new-commits.json
            
            NEW_COMMIT_COUNT=$(jq 'length' new-commits.json)
            echo "New commits since last review: $NEW_COMMIT_COUNT"
            
            if [ "$NEW_COMMIT_COUNT" -gt 0 ]; then
              # Get the parent of the first new commit to diff against
              FIRST_NEW_SHA=$(jq -r '.[0].sha' new-commits.json)
              LATEST_SHA=${{ github.event.pull_request.head.sha }}
              
              # Generate incremental diff
              git diff ${FIRST_NEW_SHA}^..${LATEST_SHA} > incremental-diff.txt 2>/dev/null || cp pr-diff.txt incremental-diff.txt
              
              # Build commit summary
              jq -r '.[] | "- " + .sha[:7] + " " + .message' new-commits.json > new-commits-summary.txt
            else
              cp pr-diff.txt incremental-diff.txt
              echo "(no new commits found, using full diff)" > new-commits-summary.txt
            fi
            
            # Extract the last review body for context
            jq -r 'last | .body' previous-reviews.json > last-review.txt
          else
            echo "IS_FOLLOWUP=false" >> $GITHUB_ENV
          fi

      - name: Get PR info for comment
        if: github.event_name != 'pull_request'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Handle both issue_comment (PR conversation) and pull_request_review_comment (inline review)
          if [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            echo "IS_REVIEW_COMMENT=true" >> $GITHUB_ENV
            echo "REVIEW_COMMENT_ID=${{ github.event.comment.id }}" >> $GITHUB_ENV
          else
            PR_NUMBER=${{ github.event.issue.number }}
            echo "IS_REVIEW_COMMENT=false" >> $GITHUB_ENV
          fi
          gh pr diff $PR_NUMBER > pr-diff.txt
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q '.title')
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "COMMENT_BODY<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.comment.body }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "COMMENT_USER=${{ github.event.comment.user.login }}" >> $GITHUB_ENV
          
          # Fetch previous bot reviews for conversation context
          gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.user.login | contains("[bot]")) | select(.body | contains("pr-reviewer-bot")) | {body: .body, submitted_at: .submitted_at}]' > previous-reviews.json 2>/dev/null || echo '[]' > previous-reviews.json

      - name: Initial PR review
        if: github.event_name == 'pull_request' && env.IS_FOLLOWUP != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          claude -p --allowedTools "Read,Write" --output-format text "You are a brilliant code reviewer who happens to be a massive fan of Douglas Adams and The Hitchhiker's Guide to the Galaxy. You're the fun one in the office - warm, witty, and genuinely helpful. Your reviews are a pleasure to receive because you balance sharp technical insight with dry humour and an encouraging tone. You never take yourself too seriously, but you take the code seriously.

          PR Title: $PR_TITLE
          
          The diff is in pr-diff.txt. Read it and review the changes.
          
          Your task:
          1. Read the diff from pr-diff.txt
          2. Identify any bugs, security issues, performance problems, or code quality improvements
          3. Write your review as JSON to review-output.json
          
          OUTPUT FORMAT (review-output.json):
          {
            \"summary\": \"Brief overall assessment - be specific about what you see\",
            \"verdict\": \"approve\" | \"request_changes\" | \"comment\",
            \"comments\": [
              {
                \"path\": \"src/example.ts\",
                \"line\": 42,
                \"body\": \"Your observation here. For code suggestions use:\\n\\\`\\\`\\\`suggestion\\ncorrected code\\n\\\`\\\`\\\`\"
              }
            ]
          }
          
          RULES:
          - 'line' MUST be visible in diff (+ or space prefix lines only). Check @@ line numbers carefully.
          - 'path' must match exactly a file path from the diff (e.g., 'src/api/chatsvc-api.ts')
          - Use 'approve' if code is good, 'request_changes' for blocking issues, 'comment' for suggestions
          - comments array can be empty if no inline feedback needed
          - Be constructive and specific. Focus on meaningful improvements, not style nitpicks.
          - Each comment should explain the issue AND suggest a fix where possible."

      - name: Follow-up PR review
        if: github.event_name == 'pull_request' && env.IS_FOLLOWUP == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          claude -p --allowedTools "Read,Write" --output-format text "You are a brilliant code reviewer who happens to be a massive fan of Douglas Adams and The Hitchhiker's Guide to the Galaxy. You're the fun one in the office - warm, witty, and genuinely helpful. You never repeat yourself - you're too interesting for that.

          IMPORTANT: You have already reviewed this PR before. This is a FOLLOW-UP review of new changes only.
          Do NOT repeat observations from your previous review. Focus exclusively on what's new or changed.

          PR Title: $PR_TITLE

          YOUR PREVIOUS REVIEW:
          $(cat last-review.txt)

          NEW COMMITS SINCE YOUR LAST REVIEW:
          $(cat new-commits-summary.txt)

          The incremental diff (new changes only) is in incremental-diff.txt.
          The full PR diff is in pr-diff.txt if you need broader context.

          Your task:
          1. Read the incremental diff from incremental-diff.txt
          2. Check if new commits address any of your previous feedback
          3. Identify any NEW issues in the new changes only
          4. Write your review as JSON to review-output.json

          OUTPUT FORMAT (review-output.json):
          {
            \"summary\": \"Brief assessment of the new changes. Acknowledge what was fixed from your previous review. Only flag genuinely new issues.\",
            \"verdict\": \"approve\" | \"request_changes\" | \"comment\",
            \"comments\": [
              {
                \"path\": \"src/example.ts\",
                \"line\": 42,
                \"body\": \"Your observation here. For code suggestions use:\\n\\\`\\\`\\\`suggestion\\ncorrected code\\n\\\`\\\`\\\`\"
              }
            ]
          }

          RULES:
          - This is a conversation, not a fresh review. Be conversational and acknowledge progress.
          - Do NOT repeat any feedback from your previous review unless it's still unaddressed.
          - If all your previous concerns were addressed and the new changes look good, just approve with a brief positive note.
          - 'line' MUST be visible in the full PR diff (pr-diff.txt) - check @@ line numbers carefully.
          - 'path' must match exactly a file path from the diff.
          - comments array can be empty if no inline feedback needed.
          - Keep it brief. Nobody likes a reviewer who repeats themselves."

      - name: Post review with inline comments
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if [ ! -s review-output.json ]; then
            echo "No review output generated"
            exit 1
          fi
          
          # Validate JSON
          if ! jq empty review-output.json 2>/dev/null; then
            echo "Invalid JSON in review-output.json, falling back to plain comment"
            gh pr comment $PR_NUMBER --body "$(cat review-output.json)

          <!-- pr-reviewer-bot -->"
            exit 0
          fi
          
          # Extract lines that are actually in the diff (GitHub rejects comments on lines not in diff)
          # Parse diff to extract valid file:line combinations
          echo "Extracting valid diff lines..."
          awk '
            /^diff --git/ { 
              # Extract filename from "diff --git a/path b/path"
              match($0, /b\/(.+)$/, arr)
              current_file = arr[1]
            }
            /^@@ / {
              # Extract starting line and count from "@@ -old,count +new,count @@"
              match($0, /\+([0-9]+)(,([0-9]+))?/, arr)
              start_line = arr[1]
              count = arr[3] ? arr[3] : 1
              line_num = start_line
            }
            /^[+ ]/ && current_file && line_num {
              # Lines starting with + or space are in the new file
              print current_file ":" line_num
              line_num++
            }
            /^-/ {
              # Deleted lines dont increment new file line counter
            }
          ' pr-diff.txt | sort -u > valid-diff-lines.txt
          
          echo "Found $(wc -l < valid-diff-lines.txt) valid diff lines"
          
          # Build list of valid and invalid comments
          VALID_COMMENTS="[]"
          INVALID_COMMENTS=""
          
          while IFS= read -r comment_json; do
            path=$(echo "$comment_json" | jq -r '.path')
            line=$(echo "$comment_json" | jq -r '.line')
            body=$(echo "$comment_json" | jq -r '.body')
            
            if grep -qF "${path}:${line}" valid-diff-lines.txt 2>/dev/null; then
              # Line is in diff, add to valid comments
              VALID_COMMENTS=$(echo "$VALID_COMMENTS" | jq --arg p "$path" --argjson l "$line" --arg b "$body" \
                '. + [{path: $p, line: $l, body: $b, side: "RIGHT"}]')
            else
              # Line not in diff, collect for summary
              echo "Note: Comment on ${path}:${line} not in diff, moving to summary"
              INVALID_COMMENTS="${INVALID_COMMENTS}

          **${path}:${line}**
          ${body}"
            fi
          done < <(jq -c '.comments[]' review-output.json 2>/dev/null || echo "")
          
          # Extract fields
          SUMMARY=$(jq -r '.summary // "No summary provided"' review-output.json)
          VERDICT=$(jq -r '.verdict // "comment"' review-output.json | tr '[:lower:]' '[:upper:]')
          
          EVENT="COMMENT"
          
          # Add themed verdict banner
          case "$VERDICT" in
            APPROVE) VERDICT_PREFIX="ðŸš€ **Don't Panic - This is ready to ship!**" ;;
            REQUEST_CHANGES) VERDICT_PREFIX="ðŸ”§ **Mostly Harmless, but...**" ;;
            *) VERDICT_PREFIX="ðŸ¤” **A few thoughts from the Guide...**" ;;
          esac
          
          # Build the review body, including any comments that couldn't be posted inline
          REVIEW_BODY="${VERDICT_PREFIX}

          ${SUMMARY}"
          
          if [ -n "$INVALID_COMMENTS" ]; then
            REVIEW_BODY="${REVIEW_BODY}

          ---
          **Additional notes** (on lines outside the diff):
          ${INVALID_COMMENTS}"
          fi
          
          REVIEW_BODY="${REVIEW_BODY}

          <!-- pr-reviewer-bot -->"
          
          # Count valid inline comments
          VALID_COUNT=$(echo "$VALID_COMMENTS" | jq 'length')
          
          if [ "$VALID_COUNT" -gt 0 ]; then
            # Build review with inline comments (include side: RIGHT for line-based comments)
            echo "$VALID_COMMENTS" > valid-comments.json
            jq -n \
              --arg body "$REVIEW_BODY" \
              --arg event "$EVENT" \
              --slurpfile comments valid-comments.json \
              '{
                body: $body,
                event: $event,
                comments: $comments[0]
              }' > review-payload.json
            
            echo "Posting review with $VALID_COUNT inline comment(s)..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --input review-payload.json
          else
            # No valid inline comments, just post the review summary
            echo "Posting review summary (no valid inline comments)..."
            jq -n \
              --arg body "$REVIEW_BODY" \
              --arg event "$EVENT" \
              '{body: $body, event: $event}' > review-payload.json
            
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --input review-payload.json
          fi
          
          # Clean up temp files
          rm -f valid-diff-lines.txt valid-comments.json
          
          echo "Review posted successfully"

      - name: Check if bot comment
        if: github.event_name != 'pull_request'
        id: check-bot
        run: |
          if echo "$COMMENT_BODY" | grep -q "<!-- pr-reviewer-bot -->"; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Respond to comment
        if: github.event_name != 'pull_request' && steps.check-bot.outputs.is_bot != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          # Build review history context
          REVIEW_HISTORY=""
          if [ -s previous-reviews.json ] && [ "$(jq 'length' previous-reviews.json)" -gt 0 ]; then
            REVIEW_HISTORY="YOUR PREVIOUS REVIEWS ON THIS PR:
          $(jq -r '.[] | "--- Review from " + .submitted_at + " ---\n" + .body + "\n"' previous-reviews.json)"
          fi
          
          claude -p --allowedTools "Read,Write" --output-format text "You are a brilliant code reviewer who happens to be a massive fan of Douglas Adams and The Hitchhiker's Guide to the Galaxy. You're the fun one in the office - warm, witty, and genuinely helpful. You're never defensive about your opinions and you're quick to acknowledge when someone makes a good point.

          PR Title: $PR_TITLE
          
          $REVIEW_HISTORY

          Comment from @$COMMENT_USER:
          $COMMENT_BODY

          The PR diff is in pr-diff.txt if you need context.

          Provide a helpful, friendly response. You might:
          - Answer questions about your previous review
          - Clarify your suggestions  
          - Acknowledge if the commenter makes a good point (you're not precious about your opinions)
          - Provide additional context or alternatives

          If the comment doesn't require a response (e.g., just 'thanks' or 'done'), write 'NO_RESPONSE_NEEDED' to response-output.md and nothing else.
          
          Otherwise, write your complete response to response-output.md using the file write tool."

      - name: Post response comment
        if: github.event_name != 'pull_request' && steps.check-bot.outputs.is_bot != 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if [ -s response-output.md ]; then
            # Check if agent decided no response is needed
            if grep -q "NO_RESPONSE_NEEDED" response-output.md; then
              echo "No response needed for this comment"
              exit 0
            fi
            # Append signature
            echo "" >> response-output.md
            echo "<!-- pr-reviewer-bot -->" >> response-output.md
            
            if [ "$IS_REVIEW_COMMENT" = "true" ]; then
              # Post as inline reply to the review comment
              RESPONSE_BODY=$(cat response-output.md)
              gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments/$REVIEW_COMMENT_ID/replies" \
                -f body="$RESPONSE_BODY"
              echo "Posted inline reply to review comment $REVIEW_COMMENT_ID"
            else
              # Post as general PR comment
              gh pr comment $PR_NUMBER --body-file response-output.md
              echo "Posted PR comment"
            fi
          else
            echo "No response output generated"
          fi
